import { model, modelEmd, supabaseClient } from "./server";
import { oneLine, stripIndent } from "common-tags";
const asyncHandler = require("express-async-handler");


export const getQuery = asyncHandler(async(req, res) =>

    const { query } = await req.body;

    if (!query) {
        res.status(400);
		throw new Error("Please Enter a message");
    }

    const embeddingResponse = await modelEmd.embedContent(query);
    const embedding = embeddingResponse.embedding.values;

    const history = await supabase.from('history').select()

    const { data: documents, error } = await supabaseClient.rpc(
        "match_documents12",
        {
        query_embedding: embedding,
        match_threshold: 0.2,
        match_count: 10,
        }
    );

    let contextText = "";

    for (let i = 0; i < documents.length; i++) {
        const document = documents[i];
        const content = document.content;
        contextText += `${content.trim()}---\n`;
    }

    const prompt = stripIndent`${oneLine`
        You are a representative that is very helpful when it comes to talking about AlumAI database! Only ever answer
        truthfully and be as helpful as you can!"`}
        Context sections:
        ${contextText}
        Question: """
        ${query}
        """
        Here is chat History: """
        ${history}
        """
        Answer as simple text:
    `;

    // generate response
    const result = await model.generateContent(prompt);
    const response = result.response;
    const text = response.text();
    console.log(text);
    await supabaseClient.from("history").insert({
        content: query
    });
    return text;
)